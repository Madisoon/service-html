define(function(require,exports,module){function e(){var e={},t=$(".form-control.customer-get-number").val(),r=$(".form-control.customer-name").val(),n=$("#customer-status").val(),o=$(".form-control.customer-post-scheme").val(),i=$(".form-control.customer-create").val();return""!==t&&(e.get_number=t),""!==r&&(e.customer_name=r),""!==n&&(e.customer_status=n),""!==o&&(e.customer_scheme=o),""!==i&&(e.customer_creater=i),e}function t(e,t,r){var o=$.fn.zTree.getZTreeObj("area-tree"),i=o.transformToArray(r);p=r.id;for(var a=i.length,s=[],c=0;c<a;c++)s.push(i[c].id);d=s,n()}function r(e,t,r){for(var n=$.fn.zTree.getZTreeObj("area-tree"),o=n.transformToArray(r),i=o.length,a=[],s=0;s<i;s++)a.push(o[s].id);u.movement.schemeManage.getAllSchemeById(a.join(","),function(e){for(var t=e.data,r=e.total,n=[],o=0;o<r;o++)n.push('<label class="radio-inline">'),n.push('<input type="radio" name="schemeOptions" schemeName="'+t[o].scheme_name+'"  value="'+t[o].id+'" checked>'),n.push(""+t[o].scheme_name),n.push("</label>");$("#search-scheme-name").val(""),$(".scheme-info").empty(),$(".scheme-info").append(n.join(""))})}function n(){$("#customer-info").bootstrapTable("destroy"),$("#customer-info").bootstrapTable({columns:[{checkbox:!0},{field:"customer_name",searchable:!0,sortable:!0,title:"客户名称"},{field:"scheme_name",searchable:!0,title:"发送方案"},{field:"get_numbers",title:"qq号/群号",formatter:function(e,t,r){for(var n=e.split(","),o=t.get_types.split(","),i=[],a=o.length,s=0;s<a;s++)"qq"!=o[s]&&"qqGroup"!=o[s]||i.push(n[s]);return i.join("|")}},{field:"get_numbers",title:"手机号",formatter:function(e,t,r){for(var n=e.split(","),o=t.get_types.split(","),i=[],a=o.length,s=0;s<a;s++)"number"==o[s]&&i.push(n[s]);return i.join("|")}},{field:"get_numbers",title:"微信号",formatter:function(e,t,r){for(var n=e.split(","),o=t.get_types.split(","),i=[],a=o.length,s=0;s<a;s++)"weixin"!=o[s]&&"weixinGroup"!=o[s]||i.push(n[s]);return i.join("|")}},{field:"user_name",title:"创建人"},{field:"customer_end_time",searchable:!0,title:"结束时间"},{field:"customer_status",searchable:!0,title:"状态",formatter:function(e,t,r){return 1==e?"启用":"停用"}}],pageNumber:1,pageSize:25,dataField:"data",undefinedText:"--",sidePagination:"client",showColumns:"true",classes:"table table-bordered table-hover",method:"post",url:u.baseUrl+"/getAllServeCustomer",queryParamsType:"undefined",queryParams:function(e){var t={pageNumber:e.pageNumber,pageSize:e.pageSize,areaId:d.join(","),serveCustomerSearch:JSON.stringify(g)};return console.log(t),t},pagination:!0,paginationHAlign:"left",paginationDetailHAlign:"right",onClickRow:function(e){o(e,!1),i=!1,s=layer.open({title:" 编辑客户(创建人："+e.user_name+")",type:1,area:["52%","95%"],content:$("#add-customer")}),a=e.id,"超级管理员"===m.user.role_name?$("#post-customer-btn").prop("disabled",!1):m.user.user_loginname===e.user_loginname?$("#post-customer-btn").prop("disabled",!1):$("#post-customer-btn").prop("disabled",!0)}})}function o(e,t){if(t)$("#customer-name").val(""),$(".form-control.start-time").val(""),$(".form-control.end-time").val(""),$(".panel-body.scheme-name").attr("scheme-id",""),$("#choose-qq").val("0"),$("#choose-weixin").val("0"),$(".panel-body.scheme-name").text("请选择方案"),$(".list-group.qq").empty(),$(".list-group.qq-group").empty(),$(".list-group.number").empty(),$(".list-group.weixin").empty(),$(".list-group.weixin-group").empty(),$(".customer-status input[value=1]").prop("checked",!0),$(".customer-grade-value[value=1]").prop("checked",!0),$(".plan-time-interval").show();else{$("input[name=customer-status][value="+e.customer_status+"]").prop("checked",!0),1==e.customer_status?$(".plan-time-interval").show():$(".plan-time-interval").hide(),$(".customer-grade-value[value="+e.customer_priority+"]").prop("checked",!0),$("#customer-name").val(e.customer_name),$(".form-control.start-time").val(e.customer_start_time),$(".form-control.end-time").val(e.customer_end_time),$(".panel-body.scheme-name").attr("scheme-id",e.customer_scheme),$("#choose-qq").val(e.customer_post_qq),$("#choose-weixin").val(e.customer_post_weixin),$(".panel-body.scheme-name").text(e.scheme_name);for(var r=e.get_numbers.split(","),n=e.get_remarks.split(","),o=e.get_types.split(","),i=r.length,a=[],s=[],c=[],l=[],u=[],m=0;m<i;m++)"qq"===o[m]?(a.push('<li class="list-group-item">'),a.push('<span class="word" word-number="'+r[m]+'" word-remark="'+n[m]+'">'+r[m]+"--"+n[m]+"</span>"),a.push('<span class="glyphicon glyphicon-remove span-icon-cursor info"></span>'),a.push("</li>")):"qqGroup"===o[m]?(s.push('<li class="list-group-item">'),s.push('<span class="word" word-number="'+r[m]+'" word-remark="'+n[m]+'">'+r[m]+"--"+n[m]+"</span>"),s.push('<span class="glyphicon glyphicon-remove span-icon-cursor info"></span>'),s.push("</li>")):"weixin"===o[m]?(l.push('<li class="list-group-item">'),l.push('<span class="word" word-number="'+r[m]+'" word-remark="'+n[m]+'">'+r[m]+"--"+n[m]+"</span>"),l.push('<span class="glyphicon glyphicon-remove span-icon-cursor info"></span>'),l.push("</li>")):"weixinGroup"===o[m]?(u.push('<li class="list-group-item">'),u.push('<span class="word" word-number="'+r[m]+'" word-remark="'+n[m]+'">'+r[m]+"--"+n[m]+"</span>"),u.push('<span class="glyphicon glyphicon-remove span-icon-cursor info"></span>'),u.push("</li>")):(c.push('<li class="list-group-item">'),c.push('<span class="word" word-number="'+r[m]+'" word-remark="'+n[m]+'">'+r[m]+"--"+n[m]+"</span>"),c.push('<span class="glyphicon glyphicon-remove span-icon-cursor info"></span>'),c.push("</li>"));$(".list-group.qq").empty(),$(".list-group.qq-group").empty(),$(".list-group.number").empty(),$(".list-group.weixin").empty(),$(".list-group.weixin-group").empty(),$(".list-group.qq").append(a.join("")),$(".list-group.qq-group").append(s.join("")),$(".list-group.number").append(c.join("")),$(".list-group.weixin").append(l.join("")),$(".list-group.weixin-group").append(u.join("")),$(".glyphicon-remove.info").unbind("click").click(function(){$(this).parent().remove()})}}var i,a,s,c,l,u=require("../../common/api"),m=window.parent.SYSTEM,p="",d=[],h="",g={};$.datetimepicker.setLocale("zh"),$(".start-time").datetimepicker({format:"Y-m-d",onShow:function(e){this.setOptions({maxDate:!!$(".end-time").val()&&$(".end-time").val()})},timepicker:!1}),$(".end-time").datetimepicker({format:"Y-m-d",onShow:function(e){this.setOptions({minDate:!!$(".start-time").val()&&$(".start-time").val()})},timepicker:!1}),$(".customer-status input").unbind("click").click(function(){"0"==$(".customer-status input[name=customer-status]:checked").val()?$(".plan-time-interval").stop().fadeOut():$(".plan-time-interval").stop().fadeIn()}),$(".span-icon-cursor.add").unbind("click").click(function(){h=$(this).attr("addType"),c=layer.open({title:"添加发送信息",type:1,area:["33%","45%"],content:$("#add-remark-info")})}),$("#cancel-remark-btn").unbind("click").click(function(){layer.close(c)}),$(".glyphicon-remove.info").unbind("click").click(function(){$(this).parent().remove()}),$("#export-data").unbind("click").click(function(){u.movement.severCustomer.exportCustomerData(d.join(","),JSON.stringify(e()),$(this).attr("exportType"),function(e){console.log(e),1==e.result?window.open("http://118.178.237.219:8080/dummyPath/"+e.url):layer.msg("无可导出的数据!",{time:1500})})}),$("#post-remark-btn").unbind("click").click(function(){var e=[],t=$(".number-info").val(),r=$(".remark-info").val();e.push('<li class="list-group-item">'),e.push('<span class="word" word-number="'+t+'" word-remark="'+r+'">'+t+"--"+r+"</span>"),e.push('<span class="glyphicon glyphicon-remove span-icon-cursor info"></span>'),e.push("</li>"),layer.close(c),"qq"===h?$(".list-group.qq").append(e.join("")):"qqGroup"===h?$(".list-group.qq-group").append(e.join("")):"weixin"===h?$(".list-group.weixin").append(e.join("")):"weixinGroup"===h?$(".list-group.weixin-group").append(e.join("")):$(".list-group.number").append(e.join("")),$(".number-info").val(""),$(".remark-info").val(""),$(".glyphicon-remove.info").unbind("click").click(function(){$(this).parent().remove()})}),$(".add-scheme").unbind("click").click(function(){l=layer.open({title:"添加发送信息",type:1,area:["52%","95%"],content:$("#scheme-choose-dialog")})}),$("#delete-customer-btn").unbind("click").click(function(){var e=$("#customer-info").bootstrapTable("getSelections",null),t=e.length,r=[];if(0===t)layer.msg(" 没 有 选 中 任 何 数 据 ");else{for(var o=0;o<t;o++)r.push(e[o].id);u.movement.severCustomer.deleteServeCustomer(r.join(","),function(e){e.result?(n(),layer.msg(" 删 除 成 功 ！",{icon:1,time:1200})):layer.msg(" 删 除 失 败 ！",{icon:2,time:1200})})}}),$("#sure-choose-scheme").unbind("click").click(function(){g=e(),n()}),u.movement.configureManage.getAllQq(function(e){for(var t=e.data,r=e.data.length,n=[],o=0;o<r;o++)n.push('<option value="'+t[o].id+'">'+t[o].qq_number+"--"+t[o].qq_name+"</option>");$("#choose-qq").append(n.join(","))});var f={callback:{onClick:t},data:{simpleData:{enable:!0,idKey:"id",pIdKey:"area_parent",rootPId:0}}},b=null;u.system.areaManage.getAllArea(function(e){b=e.data,p=e.data[0].id,$.fn.zTree.init($("#area-tree"),f,b);var t=$.fn.zTree.getZTreeObj("area-tree"),r=t.getNodeByParam("id",e.data[0].id);t.selectNode(r),t.setting.callback.onClick(null,t.setting.treeId,r)});var v={callback:{onClick:r},data:{simpleData:{enable:!0,idKey:"id",pIdKey:"area_parent",rootPId:0}}},y=null;u.system.areaManage.getAllArea(function(e){y=e.data,$.fn.zTree.init($("#scheme-area-tree"),v,y)}),$("#search-show-btn").unbind("click").click(function(){$(".customer-search").stop().slideToggle()}),$("#add-customer-btn").unbind("click").click(function(){o(null,!0),$("#post-customer-btn").prop("disabled",!1),i=!0,s=layer.open({title:" 新增客户(创建人："+m.user.user_name+")",type:1,area:["52%","95%"],content:$("#add-customer")})}),$("#cancel-scheme-btn").unbind("click").click(function(){layer.close(l)}),$("#post-scheme-btn").unbind("click").click(function(){layer.close(l);var e=$("input[name=schemeOptions]:checked").val(),t=$("input[name=schemeOptions]:checked").attr("schemeName");$(".panel-body.scheme-name").text(t),$(".panel-body.scheme-name").attr("scheme-id",e)}),$("#cancel-customer-btn").unbind("click").click(function(){layer.close(s)}),$(".search-scheme").unbind("click").click(function(){var e=$("#search-scheme-name").val();""==e?$(".radio-inline").show():($(".radio-inline").hide(),$(".radio-inline input[schemeName="+e+"]").parent().show())}),$("#post-customer-btn").unbind("click").click(function(){var e=($("#choose-qq").val(),{customer_name:$("#customer-name").val(),customer_start_time:$(".form-control.start-time").val(),customer_end_time:$(".form-control.end-time").val(),customer_status:$("input[name=customer-status]:checked").val(),customer_priority:$(".customer-grade-value:checked").val(),customer_scheme:$(".panel-body.scheme-name").attr("scheme-id"),customer_creater:m.user.user_loginname,customer_post_qq:$("#choose-qq").val(),customer_post_weixin:$("#choose-weixin").val()}),t=[];$(".list-group.qq .word").each(function(){var e={get_number:"",get_remark:"",get_type:"qq"};e.get_number=$(this).attr("word-number"),e.get_remark=$(this).attr("word-remark"),t.push(e)}),$(".list-group.qq-group .word").each(function(){var e={get_number:"",get_remark:"",get_type:"qqGroup"};e.get_number=$(this).attr("word-number"),e.get_remark=$(this).attr("word-remark"),t.push(e)}),$(".list-group.number .word").each(function(){var e={get_number:"",get_remark:"",get_type:"number"};e.get_number=$(this).attr("word-number"),e.get_remark=$(this).attr("word-remark"),t.push(e)}),$(".list-group.weixin .word").each(function(){var e={get_number:"",get_remark:"",get_type:"weixin"};e.get_number=$(this).attr("word-number"),e.get_remark=$(this).attr("word-remark"),t.push(e)}),$(".list-group.weixin-group .word").each(function(){var e={get_number:"",get_remark:"",get_type:"weixinGroup"};e.get_number=$(this).attr("word-number"),e.get_remark=$(this).attr("word-remark"),t.push(e)}),""===e.customer_name||""===e.customer_start_time||""===e.customer_end_time||""===e.customer_scheme||0===t.length?layer.msg("抱歉,数据没有填写完整！",{time:1500,zIndex:layer.zIndex,success:function(e){layer.setTop(e)}}):(layer.close(s),i?u.movement.severCustomer.insertServeCustomer(JSON.stringify(e),JSON.stringify(t),p,function(e){e.result?(n(),layer.msg(" 添 加 成 功 ！",{icon:1,time:1200})):layer.msg(" 添 加 失 败 ！",{icon:2,time:1200})}):u.movement.severCustomer.updateServeCustomer(JSON.stringify(e),JSON.stringify(t),a,function(e){e.result?(n(),layer.msg(" 修 改 成 功 ！",{icon:1,time:1200})):layer.msg(" 修 改 失 败 ！",{icon:2,time:1200})}))}),u.movement.configureManage.getAllWx(function(e){console.log(e);for(var t=e.data,r=e.total,n=[],o=0;o<r;o++)n.push('<option value="'+t[o].wx_number+'">'+t[o].wx_number+"--"+t[o].wx_remark+"</option>");$("#choose-weixin").append(n.join(""))}),n()});