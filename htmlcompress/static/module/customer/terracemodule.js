define(function(require,exports,module){function e(e,a,r){var n=$.fn.zTree.getZTreeObj("area-tree"),c=n.transformToArray(r);g=r.id;for(var o=c.length,l=[],i=0;i<o;i++)l.push(c[i].id);m=l,t()}function a(){var e={terraceData:{},terraceTagId:[]},a=[];return $(".terrace-grade:checked").each(function(){a.push($(this).val())}),e.terraceData={terrace_module_name:$("#terrace-name").val(),terrace_module_imp:$("#terrace-imp").val(),terrace_module_no_imp:$("#terrace-no-imp").val(),terrace_module_grade:a.join(","),terrace_module_plan:$("#plan-select").val(),terrace_module_create:l.user.user_loginname,terrace_module_status:$(".terrace-status:checked").val(),terrace_module_interval:$("#terrace-interval").val()},$(".label-primary.terrace-tag").each(function(){e.terraceTagId.push($(this).attr("tag-id"))}),e}function t(){$("#all-terrace-table").bootstrapTable("destroy"),$("#all-terrace-table").bootstrapTable({columns:[{checkbox:!0},{field:"terrace_module_name",searchable:!0,sortable:!0,title:"模块名称"},{field:"tag_names",searchable:!0,title:"标签"},{field:"terrace_module_imp",searchable:!0,title:"匹配关键词"},{field:"terrace_module_no_imp",title:"排除关键词"},{field:"terrace_module_grade",title:"信息级别"},{field:"plan_name",title:"计划任务名称"},{field:"terrace_module_time",searchable:!0,title:"修改时间"},{field:"user_name",searchable:!0,title:"创建人"}],pageNumber:1,pageSize:10,dataField:"data",undefinedText:"--",sidePagination:"server",showColumns:"true",classes:"table table-bordered table-hover",method:"post",showExport:!0,exportDataType:"basic",url:n.baseUrl+"/getAllTerraceModuleChoose",queryParamsType:"undefined",queryParams:function(e){return{areaId:m.join(","),chooseTerraceData:JSON.stringify(u),tagId:f.join(",")}},pagination:!0,paginationHAlign:"left",paginationDetailHAlign:"right",onClickRow:function(e){h=e.id,p=!1,i=layer.open({title:"模块编辑",type:1,area:["52%","98%"],content:$("#terrace-add-dialog")}),r(e,!1),"超级管理员"===l.user.role_name?$("#terrace-post-btn").prop("disabled",!1):l.user.user_loginname===e.user_loginname?$("#terrace-post-btn").prop("disabled",!1):$("#terrace-post-btn").prop("disabled",!0)},onLoadSuccess:function(e){}})}function r(e,a){console.log(e);$.fn.zTree.getZTreeObj("tag-tree");if(c.tagOperation.writeTagData(!1,"","tag-tree"),a)$("#terrace-tag-show").empty(),$(".terrace-grade").prop("checked",!0),$("#terrace-name").val(""),$("#terrace-imp").val(""),$("#terrace-no-imp").val(""),$("#plan-select").val(""),$("#terrace-interval").val("5"),$(".terrace-status[value=0]").prop("checked",!0);else{$(".terrace-grade").prop("checked",!1),$("#terrace-name").val(e.terrace_module_name),$("#terrace-imp").val(e.terrace_module_imp),$("#terrace-no-imp").val(e.terrace_module_no_imp),$("#plan-select").val(e.terrace_module_plan),$("#terrace-interval").val(e.terrace_module_interval);for(var t=e.tag_ids.split(","),r=e.tag_names.split(","),n=t.length,o=[],l=0;l<n;l++)c.tagOperation.writeTagData(!0,t[l],"tag-tree"),o.push('<span class="label label-primary span-icon-cursor terrace-tag" tag-id="'+t[l]+'">'+r[l]+'&nbsp;&nbsp;<span class="glyphicon  glyphicon-remove"></span></span>');$("#terrace-tag-show").empty(),$("#terrace-tag-show").append(o.join("")),$(".terrace-tag").unbind("click").click(function(){$(this).addClass("animated zoomOut"),c.tagOperation.writeTagData(!1,$(this).attr("tag-id"),"tag-tree");var e=this;setTimeout(function(){$(e).remove()},1e3)});for(var i=e.terrace_module_grade.split(","),s=i.length,l=0;l<s;l++)$(".terrace-grade[value="+i[l]+"]").prop("checked",!0);$(".terrace-status[value="+e.terrace_status+"]").prop("checked",!0)}}var n=require("../../common/api"),c=require("../../common/tagshow"),o=require("../../common/tagshow"),l=window.parent.SYSTEM;console.log(l);var i,s,d,p,u,g="",m=[],h="",f=[],_={callback:{onClick:e},data:{simpleData:{enable:!0,idKey:"id",pIdKey:"area_parent",rootPId:0}}},b=null;n.system.areaManage.getAllArea(function(e){b=e.data,g=e.data[0].id,$.fn.zTree.init($("#area-tree"),_,b);var a=$.fn.zTree.getZTreeObj("area-tree"),t=a.getNodeByParam("id",e.data[0].id);a.selectNode(t),a.setting.callback.onClick(null,a.setting.treeId,t)}),$("#add-terrace").unbind("click").click(function(){$("#terrace-post-btn").prop("disabled",!1),r("",!0),p=!0,i=layer.open({title:" 新增模块 (创建者:"+l.user.user_name+")",type:1,area:["52%","98%"],content:$("#terrace-add-dialog")})}),$("#add-terrace-tag").unbind("click").click(function(){s=layer.open({title:"标 签 选 择",type:1,area:["32%","98%"],content:$("#terrace-tag-dialog"),zIndex:layer.zIndex,success:function(e){layer.setTop(e)}})}),$("#choose-terrace").unbind("click").click(function(){$(".terrace-choose-input").stop().slideToggle()}),$(".form-control.terrace-choose-tag").focus(function(){o.tagOperation.writeDomTag(!0,"choose-tag-tree"),d=layer.open({title:"标 签 选 择",type:1,area:["32%","98%"],content:$("#choose-terrace-tag-dialog")})}),$("#choose-cancel-btn").unbind("click").click(function(){layer.close(d)}),$("#choose-tag-btn").unbind("click").click(function(){layer.close(d);for(var e=o.tagOperation.getTreeValue(!0,"choose-tag-tree"),a=e.length,t=[],r=[],n=0;n<a;n++)t.push(e[n].id),r.push(e[n].name);f=t,$(".form-control.terrace-choose-tag").val(r.join(","))}),$("#choose-terrace-sure").unbind("click").click(function(){var e={},a=$(".form-control.terrace-choose-name").val(),r=$(".form-control.terrace-choose-imp").val(),n=$(".form-control.terrace-choose-no-imp").val(),c=$("#terrace-choose-grade").val(),o=$("#terrace-choose-plan").val(),l=$(".form-control.choose-creater").val();""!=a&&(e.terrace_module_name=a),""!=r&&(e.terrace_module_imp=r),""!=n&&(e.terrace_module_no_imp=n),""!=c&&(e.terrace_module_grade=c),""!=o&&(e.terrace_module_plan=o),""!=l&&(e.user_name=l),u=e,console.log(e),t(),f=[]}),$("#add-tag-btn").unbind("click").click(function(){layer.close(s);for(var e=c.tagOperation.getTreeValue(!0,"tag-tree"),a=e.length,t=[],r=0;r<a;r++)t.push('<span class="label label-primary span-icon-cursor terrace-tag" tag-id="'+e[r].id+'">'+e[r].name+'&nbsp;&nbsp;<span class="glyphicon  glyphicon-remove"></span></span>');$("#terrace-tag-show").empty(),$("#terrace-tag-show").append(t.join("")),$(".terrace-tag").unbind("click").click(function(){$(this).addClass("animated zoomOut"),c.tagOperation.writeTagData(!1,$(this).attr("tag-id"),"tag-tree");var e=this;setTimeout(function(){$(e).remove()},1e3)})}),$("#add-cancel-btn").unbind("click").click(function(){layer.close(s)}),$("#delete-terrace").unbind("click").click(function(){var e=$("#all-terrace-table").bootstrapTable("getSelections",null),a=e.length,r=[];if(0===a)layer.msg(" 没 有 选 中 任 何 数 据 ");else{for(var c=0;c<a;c++)r.push(e[c].id);n.movement.terraceManage.deleteTerraceId(r.join(","),function(e){e.result?(t(),layer.msg(" 删 除 成 功 ！",{icon:1,time:1200})):layer.msg(" 删 除 失 败 ！",{icon:2,time:1200})})}}),c.tagOperation.writeDomTag(!0,"tag-tree"),n.movement.configureManage.getAllPlan(function(e){for(var a=e.data,t=a.length,r=[],n=0;n<t;n++)r.push('<option class="plan-option" value="'+a[n].id+'">'+a[n].plan_name+"</option>");$("#plan-select .plan-option").remove(),$("#plan-select").append(r.join("")),$("#terrace-choose-plan").append(r.join(""))}),$("#terrace-post-btn").unbind("click").click(function(){var e=a(),r=c.tagOperation.getTreeValue(!1,"tag-tree");0==e.terraceTagId.length||""==e.terraceData.terrace_name||""==e.terraceData.terrace_plan_id?layer.msg("抱歉,数据没有填写完整！",{time:1500,zIndex:layer.zIndex,success:function(e){layer.setTop(e)}}):(layer.close(i),p?n.movement.terraceManage.insertTerrace(JSON.stringify(e.terraceData),e.terraceTagId.join(","),g,r.join(","),function(e){e.result?(t(),layer.msg(" 添 加 成 功 ！",{icon:1,time:1200})):layer.msg(" 添 加 失 败 ！",{icon:2,time:1200})}):n.movement.terraceManage.updateTerrace(h,e.terraceTagId.join(","),JSON.stringify(e.terraceData),r.join(","),function(e){e.result?(t(),layer.msg(" 修 改 成 功 ！",{icon:1,time:1200})):layer.msg(" 修 改 失 败 ！",{icon:2,time:1200})}))}),$("#terrace-cancel-btn").unbind("click").click(function(){layer.close(i)}),t()});