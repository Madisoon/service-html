define(function(require,exports,module){function e(){r.tag.tagShow.getIdMax(function(e){g=e.result>0?parseInt(e.data[0].id,10)+1:1})}function t(e,t,n,i){r.tag.tagShow.updateTag(n.id,n.name,function(e){})}function n(e,t,n){n||"button"==e.target.tagName.toLowerCase()||0!=$(e.target).parents("a").length?n&&!n.noR&&(s.selectNode(n),i("node",e.clientX,e.clientY)):(s.cancelSelectedNode(),i("root",e.clientX,e.clientY))}function i(e,t,n){$("#rMenu ul").show(),"root"==e?($("#update-name").hide(),$("#delete-tag").hide()):($("#update-name").show(),$("#delete-tag").show()),u.css({top:n+"px",left:t+"px",visibility:"visible"}),$("body").bind("mousedown",o)}function a(){u&&u.css({visibility:"hidden"}),$("body").unbind("mousedown",o)}function o(e){"rMenu"==e.target.id||$(e.target).parents("#rMenu").length>0||u.css({visibility:"hidden"})}function d(){a();var t=[],n=null,i=s.getSelectedNodes();if(i.length>0){var o=i[0].getPath();console.log(o);for(var d=o.length,l=0;l<d;l++)t.push(o[l].id);n={name:"新增标签",tag_parent:s.getSelectedNodes()[0].id,id:g},s.addNodes(s.getSelectedNodes()[0],n)}else n={name:"新增标签",tag_parent:0,id:g},s.addNodes(null,n);r.tag.tagShow.insertTag(JSON.stringify(n),JSON.stringify(t),function(t){t.result>0?(e(),layer.msg(" 添 加 成 功 ！",{icon:1,time:1200})):layer.msg(" 添 加 失 败 ！",{icon:2,time:1200})})}function l(){a();var e=$.fn.zTree.getZTreeObj("treeDemo"),t=s.getSelectedNodes(),n=e.transformToArray(t[0]);t&&t.length>0&&(t[0].children&&t[0].children.length,s.removeNode(t[0]));for(var i=n.length,o=[],d=0;d<i;d++)o.push(n[d].id);r.tag.tagShow.deleteTag(o.join(","),function(e){})}function c(){a();var e=$.fn.zTree.getZTreeObj("treeDemo"),t=e.getSelectedNodes(),n=t[0];if(0==t.length)return void alert("请先选择一个节点");e.editName(n)}var r=require("../../common/api"),g=0;e();var s,u,f={edit:{enable:!0,showRemoveBtn:!1,showRenameBtn:!1},view:{dblClickExpand:!1},check:{enable:!0},callback:{onRightClick:n,onRename:t},data:{simpleData:{enable:!0,idKey:"id",pIdKey:"tag_parent",rootPId:0}}},h=null;r.tag.tagShow.getAllTag(function(e){h=e.data,$.fn.zTree.init($("#treeDemo"),f,h),s=$.fn.zTree.getZTreeObj("treeDemo"),u=$("#rMenu")}),$("#add-tag").unbind("click").click(function(){d()}),$("#update-name").unbind("click").click(function(){c()}),$("#delete-tag").unbind("click").click(function(){l()})});