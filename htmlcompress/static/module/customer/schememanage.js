define(function(require,exports,module){function e(e,a,n){var c=$.fn.zTree.getZTreeObj("area-tree"),s=c.transformToArray(n);d=n.id;for(var i=s.length,l=[],o=0;o<i;o++)l.push(s[o].id);g=l,t()}function a(){var e={schemeData:{},schemeTagId:[]},a=[];return $(".scheme-grade:checked").each(function(){a.push($(this).val())}),e.schemeData={scheme_name:$("#scheme-name").val(),scheme_imp:$("#scheme-imp").val(),scheme_no_imp:$("#scheme-no-imp").val(),scheme_link:$("#scheme-link").val(),scheme_no_link:$("#scheme-no-link").val(),scheme_grade:a.join(","),scheme_plan_id:$("#plan-select").val(),scheme_creater:l.user.user_loginname,scheme_status:$(".scheme-status:checked").val(),scheme_interval:$("#scheme-interval").val()},$(".label-primary.scheme-tag").each(function(){e.schemeTagId.push($(this).attr("tag-id"))}),e}function t(){$("#all-scheme-table").bootstrapTable("destroy"),$("#all-scheme-table").bootstrapTable({columns:[{checkbox:!0},{field:"scheme_name",searchable:!0,sortable:!0,title:"方案名称"},{field:"tag_names",searchable:!0,title:"标签"},{field:"scheme_imp",searchable:!0,title:"匹配关键词"},{field:"scheme_no_imp",title:"排除关键词"},{field:"scheme_link",searchable:!0,title:"匹配地址"},{field:"scheme_no_link",title:"排除地址"},{field:"scheme_grade",title:"信息级别"},{field:"plan_name",title:"计划任务名称"},{field:"scheme_time",searchable:!0,title:"修改时间"},{field:"user_name",searchable:!0,title:"创建人"}],pageNumber:1,pageSize:25,dataField:"data",undefinedText:"--",sidePagination:"client",showColumns:"true",classes:"table table-bordered table-hover",method:"post",showExport:!0,exportDataType:"basic",url:c.baseUrl+"/getAllSchemeChoose",queryParamsType:"undefined",queryParams:function(e){return{areaId:g.join(","),chooseSchemeData:JSON.stringify(p),tagId:f.join(",")}},pagination:!0,paginationHAlign:"left",paginationDetailHAlign:"right",onClickRow:function(e){u=e.id,h=!1,o=layer.open({title:"方案编辑",type:1,area:["52%","98%"],content:$("#scheme-add-dialog")}),n(e,!1),"超级管理员"===l.user.role_name?$("#scheme-post-btn").prop("disabled",!1):l.user.user_loginname===e.user_loginname?$("#scheme-post-btn").prop("disabled",!1):$("#scheme-post-btn").prop("disabled",!0)},onLoadSuccess:function(e){}})}function n(e,a){console.log(e);$.fn.zTree.getZTreeObj("tag-tree");if(s.tagOperation.writeTagData(!1,"","tag-tree"),a)$("#scheme-tag-show").empty(),$(".scheme-grade").prop("checked",!0),$("#scheme-name").val(""),$("#scheme-imp").val(""),$("#scheme-no-imp").val(""),$("#scheme-link").val(""),$("#scheme-no-link").val(""),$("#plan-select").val(""),$("#scheme-interval").val("5"),$(".scheme-status[value=0]").prop("checked",!0);else{$(".scheme-grade").prop("checked",!1),$("#scheme-name").val(e.scheme_name),$("#scheme-imp").val(e.scheme_imp),$("#scheme-no-imp").val(e.scheme_no_imp),$("#scheme-link").val(e.scheme_link),$("#scheme-no-link").val(e.scheme_no_link),$("#plan-select").val(e.scheme_plan_id),$("#scheme-interval").val(e.scheme_interval);for(var t=e.tag_ids.split(","),n=e.tag_names.split(","),c=t.length,i=[],l=0;l<c;l++)s.tagOperation.writeTagData(!0,t[l],"tag-tree"),i.push('<span class="label label-primary span-icon-cursor scheme-tag" tag-id="'+t[l]+'">'+n[l]+'&nbsp;&nbsp;<span class="glyphicon  glyphicon-remove"></span></span>');$("#scheme-tag-show").empty(),$("#scheme-tag-show").append(i.join("")),$(".scheme-tag").unbind("click").click(function(){$(this).addClass("animated zoomOut"),s.tagOperation.writeTagData(!1,$(this).attr("tag-id"),"tag-tree");var e=this;setTimeout(function(){$(e).remove()},1e3)});for(var o=e.scheme_grade.split(","),m=o.length,l=0;l<m;l++)$(".scheme-grade[value="+o[l]+"]").prop("checked",!0);$(".scheme-status[value="+e.scheme_status+"]").prop("checked",!0)}}var c=require("../../common/api"),s=require("../../common/tagshow"),i=require("../../common/tagshow"),l=window.parent.SYSTEM;console.log(l);var o,m,r,h,p,d="",g=[],u="",f=[],b={callback:{onClick:e},data:{simpleData:{enable:!0,idKey:"id",pIdKey:"area_parent",rootPId:0}}},v=null;c.system.areaManage.getAllArea(function(e){v=e.data,d=e.data[0].id,$.fn.zTree.init($("#area-tree"),b,v);var a=$.fn.zTree.getZTreeObj("area-tree"),t=a.getNodeByParam("id",e.data[0].id);a.selectNode(t),a.setting.callback.onClick(null,a.setting.treeId,t)}),$("#add-scheme").unbind("click").click(function(){$("#scheme-post-btn").prop("disabled",!1),n("",!0),h=!0,o=layer.open({title:" 新增方案 (创建者:"+l.user.user_name+")",type:1,area:["52%","98%"],content:$("#scheme-add-dialog")})}),$("#add-scheme-tag").unbind("click").click(function(){m=layer.open({title:"标 签 选 择",type:1,area:["32%","98%"],content:$("#scheme-tag-dialog"),zIndex:layer.zIndex,success:function(e){layer.setTop(e)}})}),$("#choose-scheme").unbind("click").click(function(){$(".scheme-choose-input").stop().slideToggle()}),$(".form-control.scheme-choose-tag").focus(function(){i.tagOperation.writeDomTag(!0,"choose-tag-tree"),r=layer.open({title:"标 签 选 择",type:1,area:["32%","98%"],content:$("#choose-scheme-tag-dialog")})}),$("#choose-cancel-btn").unbind("click").click(function(){layer.close(r)}),$("#choose-tag-btn").unbind("click").click(function(){layer.close(r);for(var e=i.tagOperation.getTreeValue(!0,"choose-tag-tree"),a=e.length,t=[],n=[],c=0;c<a;c++)t.push(e[c].id),n.push(e[c].name);f=t,$(".form-control.scheme-choose-tag").val(n.join(","))}),$("#choose-scheme-sure").unbind("click").click(function(){var e={},a=$(".form-control.scheme-choose-name").val(),n=$(".form-control.scheme-choose-imp").val(),c=$(".form-control.scheme-choose-no-imp").val(),s=$("#scheme-choose-grade").val(),i=$("#scheme-choose-plan").val(),l=$(".form-control.choose-creater").val();""!=a&&(e.scheme_name=a),""!=n&&(e.scheme_imp=n),""!=c&&(e.scheme_no_imp=c),""!=s&&(e.scheme_grade=s),""!=i&&(e.scheme_plan_id=i),""!=l&&(e.user_name=l),p=e,t()}),$("#add-tag-btn").unbind("click").click(function(){layer.close(m);for(var e=s.tagOperation.getTreeValue(!0,"tag-tree"),a=e.length,t=[],n=0;n<a;n++)t.push('<span class="label label-primary span-icon-cursor scheme-tag" tag-id="'+e[n].id+'">'+e[n].name+'&nbsp;&nbsp;<span class="glyphicon  glyphicon-remove"></span></span>');$("#scheme-tag-show").empty(),$("#scheme-tag-show").append(t.join("")),$(".scheme-tag").unbind("click").click(function(){$(this).addClass("animated zoomOut"),s.tagOperation.writeTagData(!1,$(this).attr("tag-id"),"tag-tree");var e=this;setTimeout(function(){$(e).remove()},1e3)})}),$("#add-cancel-btn").unbind("click").click(function(){layer.close(m)}),$("#delete-scheme").unbind("click").click(function(){var e=$("#all-scheme-table").bootstrapTable("getSelections",null),a=e.length,n=[];if(0===a)layer.msg(" 没 有 选 中 任 何 数 据 ");else{for(var s=0;s<a;s++)n.push(e[s].id);c.movement.schemeManage.deleteSchemeId(n.join(","),function(e){e.result?(t(),layer.msg(" 删 除 成 功 ！",{icon:1,time:1200})):layer.msg(" 删 除 失 败 ！",{icon:2,time:1200})})}}),s.tagOperation.writeDomTag(!0,"tag-tree"),c.movement.configureManage.getAllPlan(function(e){for(var a=e.data,t=a.length,n=[],c=0;c<t;c++)n.push('<option class="plan-option" value="'+a[c].id+'">'+a[c].plan_name+"</option>");$("#plan-select .plan-option").remove(),$("#plan-select").append(n.join("")),$("#scheme-choose-plan").append(n.join(""))}),$("#scheme-post-btn").unbind("click").click(function(){var e=a(),n=s.tagOperation.getTreeValue(!1,"tag-tree");0==e.schemeTagId.length||""==e.schemeData.scheme_name||""==e.schemeData.scheme_plan_id?layer.msg("抱歉,数据没有填写完整！",{time:1500,zIndex:layer.zIndex,success:function(e){layer.setTop(e)}}):(layer.close(o),h?c.movement.schemeManage.insertScheme(JSON.stringify(e.schemeData),e.schemeTagId.join(","),d,n.join(","),function(e){e.result?(t(),layer.msg(" 添 加 成 功 ！",{icon:1,time:1200})):layer.msg(" 添 加 失 败 ！",{icon:2,time:1200})}):c.movement.schemeManage.updateScheme(u,e.schemeTagId.join(","),JSON.stringify(e.schemeData),n.join(","),function(e){e.result?(t(),layer.msg(" 修 改 成 功 ！",{icon:1,time:1200})):layer.msg(" 修 改 失 败 ！",{icon:2,time:1200})}))}),$("#scheme-cancel-btn").unbind("click").click(function(){layer.close(o)}),t()});